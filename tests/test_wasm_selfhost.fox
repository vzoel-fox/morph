ambil "src/wasm_selfhost_compiler.fox"

; ==============================================================================
; WASM SELF-HOST INTEGRATION TEST
; ==============================================================================

fungsi test_wasm_dom_operations() -> i64
  var msg1 = "Test 1: WASM DOM Operations\n"
  print(msg1, 29)
  
  ; Initialize WASM DOM system
  var init_result = wasm_dom_init()
  jika (init_result != 0)
    var err1 = "âœ— WASM DOM initialization failed\n"
    print(err1, 34)
    kembali 1
  tutup_jika
  
  var ok1 = "âœ“ WASM DOM system initialized\n"
  print(ok1, 31)
  
  ; Test element creation
  var h1_tag = "h1"
  var element_id = wasm_create_element(h1_tag)
  
  jika (element_id > 0)
    var ok2 = "âœ“ DOM element created with ID: "
    print(ok2, 32)
    __mf_print_int(element_id)
    var newline = "\n"
    print(newline, 1)
  lain
    var err2 = "âœ— DOM element creation failed\n"
    print(err2, 31)
    kembali 2
  tutup_jika
  
  ; Test text setting
  var text_content = "Hello WASM!"
  wasm_set_text(element_id, text_content)
  var ok3 = "âœ“ Text content set\n"
  print(ok3, 20)
  
  ; Test append to body
  wasm_append_child(1, element_id)  ; Append to body (ID 1)
  var ok4 = "âœ“ Element appended to body\n"
  print(ok4, 28)
  
  kembali 0
tutup_fungsi

fungsi test_html_compilation() -> i64
  var msg1 = "Test 2: HTML Compilation\n"
  print(msg1, 25)
  
  ; Test HTML parsing and DOM generation
  var html_source = "<div><h2>Compiled HTML</h2><p>Success!</p></div>"
  var result = wasm_compile_html(html_source)
  
  jika (result >= 0)
    var ok1 = "âœ“ HTML compiled successfully\n"
    print(ok1, 30)
  lain
    var err1 = "âœ— HTML compilation failed\n"
    print(err1, 27)
    kembali 1
  tutup_jika
  
  kembali 0
tutup_fungsi

fungsi test_morph_syntax_compilation() -> i64
  var msg1 = "Test 3: Morph Syntax Compilation\n"
  print(msg1, 37)
  
  ; Test Morph syntax with DOM operations
  var morph_source = "__mf_dom_create(\"div\")\n__mf_dom_set_text(\"Morph Compiled\")\n__mf_dom_append(1)"
  var bytecode = wasm_compile_morph_syntax(morph_source, 70)
  
  jika (bytecode != 0)
    var ok1 = "âœ“ Morph syntax compiled to bytecode\n"
    print(ok1, 39)
    
    var bytecode_size = rpn_get_program_size()
    var ok2 = "âœ“ Generated "
    print(ok2, 12)
    __mf_print_int(bytecode_size)
    var ok3 = " RPN instructions\n"
    print(ok3, 18)
  lain
    var err1 = "âœ— Morph syntax compilation failed\n"
    print(err1, 38)
    kembali 1
  tutup_jika
  
  kembali 0
tutup_fungsi

fungsi utama() -> i64
  var banner = "=== WASM SELF-HOST INTEGRATION TEST ===\n"
  print(banner, 41)
  
  ; Initialize all systems
  symbol_table_init()
  type_system_init()
  rpn_init(2048)
  
  var version = stdlib_version()
  var init_msg = "Morph Stdlib v"
  print(init_msg, 17)
  __mf_print_int(version)
  var newline = "\n"
  print(newline, 1)
  
  ; Run all tests
  var result1 = test_wasm_dom_operations()
  jika (result1 != 0)
    kembali result1
  tutup_jika
  
  var result2 = test_html_compilation()
  jika (result2 != 0)
    kembali result2
  tutup_jika
  
  var result3 = test_morph_syntax_compilation()
  jika (result3 != 0)
    kembali result3
  tutup_jika
  
  var success = "ğŸ¯ ALL WASM SELF-HOST TESTS PASSED!\n"
  print(success, 37)
  
  var summary = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
  print(summary, 50)
  var features = "âœ… WASM Integration Complete:\n"
  print(features, 30)
  var f1 = "  â€¢ DOM manipulation via syscalls\n"
  print(f1, 34)
  var f2 = "  â€¢ HTML parser with CSS styling\n"
  print(f2, 33)
  var f3 = "  â€¢ Morph syntax compilation\n"
  print(f3, 32)
  var f4 = "  â€¢ RPN bytecode generation\n"
  print(f4, 28)
  var f5 = "  â€¢ JavaScript loader integration\n"
  print(f5, 35)
  var f6 = "  â€¢ Self-hosting compiler ready\n"
  print(f6, 32)
  
  var ready = "\nğŸš€ WASM Self-Host Compiler Ready for Production!\n"
  print(ready, 49)
  
  kembali 0
tutup_fungsi
