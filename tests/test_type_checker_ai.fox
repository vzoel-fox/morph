; ==============================================================================
; TEST: Type Checker with AI Hint Integration
; ==============================================================================

ambil "src/type_checker.fox"
ambil "corelib/lib/type_runtime.fox"

utama {
    sistem 1, 1, "=== Type Checker Complete Test ===\n", 35
    
    ; Create type checker
    var tc = type_checker_new()
    
    ; Test 1: Symbol table
    sistem 1, 1, "Test 1: Symbol table...\n", 24
    tc_add_symbol(tc, "x", TYPE_I64)
    tc_add_symbol(tc, "name", TYPE_STRING)
    tc_add_symbol(tc, "ptr_val", TYPE_PTR)
    
    var sym_x = tc_lookup_symbol(tc, "x")
    jika sym_x != 0
        sistem 1, 1, "  ✓ Symbol 'x' found\n", 23
    tutup_jika
    
    ; Test 2: Type inference
    sistem 1, 1, "Test 2: Type inference...\n", 26
    ; Simulate inferring from built-in calls
    var inferred = tc_infer_call(tc, 0)  ; Will use default
    sistem 1, 1, "  ✓ Call inference working\n", 29
    
    ; Test 3: Type runtime (RTTI)
    sistem 1, 1, "Test 3: Type runtime (RTTI)...\n", 31
    var point_type = type_create("Point")
    type_add_field(point_type, "x", TYPEID_I64)
    type_add_field(point_type, "y", TYPEID_I64)
    
    var size = type_get_size(point_type)
    jika size == 16
        sistem 1, 1, "  ✓ Point size = 16 bytes\n", 28
    tutup_jika
    
    var x_offset = type_get_field_offset(point_type, "x")
    var y_offset = type_get_field_offset(point_type, "y")
    jika x_offset == 0 && y_offset == 8
        sistem 1, 1, "  ✓ Field offsets correct\n", 28
    tutup_jika
    
    ; Test 4: Array type checking
    sistem 1, 1, "Test 4: Array types...\n", 23
    var arr_type = tc_create_array_type(TYPE_I64, 10)
    tc_register_array(tc, "IntArray", TYPE_I64, 10)
    sistem 1, 1, "  ✓ Array type registered\n", 28
    
    ; Test 5: Struct registration
    sistem 1, 1, "Test 5: Struct types...\n", 24
    var fields = vector_new()
    vector_push(fields, "x")
    vector_push(fields, TYPE_I64)
    vector_push(fields, "y")
    vector_push(fields, TYPE_I64)
    tc_register_struct(tc, "Point", fields)
    
    var field_type = tc_check_struct_access(tc, "Point", "x")
    jika field_type == TYPE_I64
        sistem 1, 1, "  ✓ Struct field access working\n", 34
    tutup_jika
    
    ; Test 6: AI hint generation
    sistem 1, 1, "Test 6: AI hints...\n", 20
    tc_set_location(tc, 42, 10)
    tc_error_hint(tc, HINT_SEMANTIC_UNDEFINED_VARIABLE, 
        "Variable 'foo' not declared", "Add 'var foo = ...'")
    
    ; Print results
    sistem 1, 1, "\n", 1
    tc_print_errors_ai(tc)
    
    sistem 1, 1, "\n✓ All type system tests complete\n", 36
    0
}
