ambil "../src/rpn_intent_system.fox"
ambil "../src/executor.fox"

utama {
    sistem 1, 1, "ðŸš€ Extended RPN + Intent Tree System Test\n", 42
    sistem 1, 1, "========================================\n", 40
    
    ; Test 1: Extended arithmetic operations
    sistem 1, 1, "\n=== Test 1: Extended Arithmetic ===\n", 37
    
    ; Test modulo: 10 % 3 = 1
    var ast_mod = ast_new(AST_BINARY)
    __mf_poke_i64(ast_mod + AST_DATA1, 37)  ; '%' operator
    
    var children_mod = vector_new()
    var left_mod = ast_new(AST_LITERAL)
    __mf_poke_i64(left_mod + AST_DATA1, 10)
    var right_mod = ast_new(AST_LITERAL)
    __mf_poke_i64(right_mod + AST_DATA1, 3)
    
    vector_push(children_mod, left_mod)
    vector_push(children_mod, right_mod)
    __mf_poke_i64(ast_mod + AST_CHILDREN, children_mod)
    
    var result_mod = compile_and_execute(ast_mod, "test_mod.morph")
    sistem 1, 1, "10 % 3 = ", 9
    print_number_simple(result_mod)
    sistem 1, 1, " (expected: 1)\n", 15
    
    ; Test 2: Comparison operations
    sistem 1, 1, "\n=== Test 2: Comparison Operations ===\n", 39
    
    ; Test equality: 5 == 5 = 1 (true)
    var ast_eq = ast_new(AST_BINARY)
    __mf_poke_i64(ast_eq + AST_DATA1, 61)  ; '=' operator (simplified)
    
    var children_eq = vector_new()
    var left_eq = ast_new(AST_LITERAL)
    __mf_poke_i64(left_eq + AST_DATA1, 5)
    var right_eq = ast_new(AST_LITERAL)
    __mf_poke_i64(right_eq + AST_DATA1, 5)
    
    vector_push(children_eq, left_eq)
    vector_push(children_eq, right_eq)
    __mf_poke_i64(ast_eq + AST_CHILDREN, children_eq)
    
    var result_eq = compile_and_execute(ast_eq, "test_eq.morph")
    sistem 1, 1, "5 == 5 = ", 9
    print_number_simple(result_eq)
    sistem 1, 1, " (expected: 1)\n", 15
    
    ; Test less than: 3 < 7 = 1 (true)
    var ast_lt = ast_new(AST_BINARY)
    __mf_poke_i64(ast_lt + AST_DATA1, 60)  ; '<' operator
    
    var children_lt = vector_new()
    var left_lt = ast_new(AST_LITERAL)
    __mf_poke_i64(left_lt + AST_DATA1, 3)
    var right_lt = ast_new(AST_LITERAL)
    __mf_poke_i64(right_lt + AST_DATA1, 7)
    
    vector_push(children_lt, left_lt)
    vector_push(children_lt, right_lt)
    __mf_poke_i64(ast_lt + AST_CHILDREN, children_lt)
    
    var result_lt = compile_and_execute(ast_lt, "test_lt.morph")
    sistem 1, 1, "3 < 7 = ", 8
    print_number_simple(result_lt)
    sistem 1, 1, " (expected: 1)\n", 15
    
    ; Test 3: Variable operations
    sistem 1, 1, "\n=== Test 3: Variable Operations ===\n", 37
    
    ; Create AST for: var x = 15; x + 5
    var ast_var = ast_new(AST_VAR_DECL)
    __mf_poke_i64(ast_var + AST_DATA1, string_hash_simple("x"))
    
    var var_children = vector_new()
    var init_value = ast_new(AST_LITERAL)
    __mf_poke_i64(init_value + AST_DATA1, 15)
    vector_push(var_children, init_value)
    __mf_poke_i64(ast_var + AST_CHILDREN, var_children)
    
    ; Convert to Intent and compile
    var intent_var = ast_to_intent(ast_var)
    var rpn_ctx = rpn_intent_new()
    intent_to_rpn(rpn_ctx, intent_var)
    
    ; Add variable access: x + 5
    var ast_var_use = ast_new(AST_BINARY)
    __mf_poke_i64(ast_var_use + AST_DATA1, 43)  ; '+' operator
    
    var use_children = vector_new()
    var var_ref = ast_new(AST_IDENT)
    __mf_poke_i64(var_ref + AST_DATA1, string_hash_simple("x"))
    var add_value = ast_new(AST_LITERAL)
    __mf_poke_i64(add_value + AST_DATA1, 5)
    
    vector_push(use_children, var_ref)
    vector_push(use_children, add_value)
    __mf_poke_i64(ast_var_use + AST_CHILDREN, use_children)
    
    var intent_use = ast_to_intent(ast_var_use)
    intent_to_rpn(rpn_ctx, intent_use)
    
    ; Write and execute
    var var_result = rpn_write_morph_file(rpn_ctx, "test_var.morph")
    jika var_result == 1
        var exec_result = execute_morph_file("test_var.morph")
        sistem 1, 1, "Variable test result: ", 22
        print_number_simple(exec_result)
        sistem 1, 1, " (expected: 20)\n", 16
    tutup_jika
    
    ; Summary
    sistem 1, 1, "\nðŸŽ‰ Extended RPN + Intent Tree Summary:\n", 39
    sistem 1, 1, "âœ… Extended arithmetic: +, -, *, /, %\n", 38
    sistem 1, 1, "âœ… Comparison operations: ==, <, >\n", 35
    sistem 1, 1, "âœ… Variable storage and retrieval\n", 34
    sistem 1, 1, "âœ… Complete AST â†’ Intent â†’ RPN pipeline\n", 40
    sistem 1, 1, "âœ… Stripe-protected .morph generation\n", 38
    sistem 1, 1, "âœ… Stack VM execution with validation\n", 38
    
    sistem 1, 1, "\nðŸ”§ Opcode Coverage:\n", 21
    sistem 1, 1, "âœ… Data: LIT, LOAD, STORE, DUP, POP\n", 36
    sistem 1, 1, "âœ… Arithmetic: ADD, SUB, MUL, DIV, MOD, NEG\n", 44
    sistem 1, 1, "âœ… Comparison: EQ, NEQ, LT, GT\n", 31
    sistem 1, 1, "âœ… Control: JMP, JZ, JNZ, LABEL\n", 32
    sistem 1, 1, "âœ… System: RET, EXIT\n", 21
    sistem 1, 1, "âš ï¸  Functions: CALL, FRAME (partial)\n", 37
    
    sistem 1, 1, "\nExtended RPN system ready for complex programs! ðŸš€\n", 52
    kembali 0
}

; Helper function: compile AST and execute
fungsi compile_and_execute(ast: ptr, filename: ptr) -> i64
    var rpn_ctx = compile_ast_to_rpn(ast)
    jika rpn_ctx == 0
        kembali -1
    tutup_jika
    
    var write_result = rpn_write_morph_file(rpn_ctx, filename)
    jika write_result == 0
        kembali -2
    tutup_jika
    
    var result = execute_morph_file(filename)
    kembali result
tutup_fungsi
