; Complete Self-Hosting Compiler + Executor Demo
ambil "../corelib/lib/std.fox"
ambil "file_extensions.fox"
ambil "parser.fox"
ambil "rpn_intent_system.fox"
ambil "executor.fox"

utama {
    sistem 1, 1, "ðŸš€ MorphFox Self-Hosting Compiler + Executor v1.4\n", 50
    sistem 1, 1, "Complete Pipeline: Source â†’ AST â†’ Intent â†’ RPN â†’ Execute\n", 56
    
    ; Test 1: Simple arithmetic (5 + 3)
    sistem 1, 1, "\n=== Test 1: Simple Arithmetic (5 + 3) ===\n", 42
    
    var ast_add = ast_new(AST_BINARY)
    __mf_poke_i64(ast_add + AST_DATA1, 43)  ; '+' operator
    
    var children1 = vector_new()
    var left1 = ast_new(AST_LITERAL)
    __mf_poke_i64(left1 + AST_DATA1, 5)
    var right1 = ast_new(AST_LITERAL)
    __mf_poke_i64(right1 + AST_DATA1, 3)
    
    vector_push(children1, left1)
    vector_push(children1, right1)
    __mf_poke_i64(ast_add + AST_CHILDREN, children1)
    
    ; Compile and execute
    var result1 = compile_and_execute(ast_add, "test1.morph")
    sistem 1, 1, "Result: ", 8
    print_number_simple(result1)
    sistem 1, 1, " (expected: 8)\n", 15
    
    ; Test 2: Multiplication (7 * 6)
    sistem 1, 1, "\n=== Test 2: Multiplication (7 * 6) ===\n", 39
    
    var ast_mul = ast_new(AST_BINARY)
    __mf_poke_i64(ast_mul + AST_DATA1, 42)  ; '*' operator
    
    var children2 = vector_new()
    var left2 = ast_new(AST_LITERAL)
    __mf_poke_i64(left2 + AST_DATA1, 7)
    var right2 = ast_new(AST_LITERAL)
    __mf_poke_i64(right2 + AST_DATA1, 6)
    
    vector_push(children2, left2)
    vector_push(children2, right2)
    __mf_poke_i64(ast_mul + AST_CHILDREN, children2)
    
    var result2 = compile_and_execute(ast_mul, "test2.morph")
    sistem 1, 1, "Result: ", 8
    print_number_simple(result2)
    sistem 1, 1, " (expected: 42)\n", 16
    
    ; Test 3: Complex expression (10 - 4)
    sistem 1, 1, "\n=== Test 3: Subtraction (10 - 4) ===\n", 37
    
    var ast_sub = ast_new(AST_BINARY)
    __mf_poke_i64(ast_sub + AST_DATA1, 45)  ; '-' operator
    
    var children3 = vector_new()
    var left3 = ast_new(AST_LITERAL)
    __mf_poke_i64(left3 + AST_DATA1, 10)
    var right3 = ast_new(AST_LITERAL)
    __mf_poke_i64(right3 + AST_DATA1, 4)
    
    vector_push(children3, left3)
    vector_push(children3, right3)
    __mf_poke_i64(ast_sub + AST_CHILDREN, children3)
    
    var result3 = compile_and_execute(ast_sub, "test3.morph")
    sistem 1, 1, "Result: ", 8
    print_number_simple(result3)
    sistem 1, 1, " (expected: 6)\n", 15
    
    ; Test 4: Division (20 / 5)
    sistem 1, 1, "\n=== Test 4: Division (20 / 5) ===\n", 34
    
    var ast_div = ast_new(AST_BINARY)
    __mf_poke_i64(ast_div + AST_DATA1, 47)  ; '/' operator
    
    var children4 = vector_new()
    var left4 = ast_new(AST_LITERAL)
    __mf_poke_i64(left4 + AST_DATA1, 20)
    var right4 = ast_new(AST_LITERAL)
    __mf_poke_i64(right4 + AST_DATA1, 5)
    
    vector_push(children4, left4)
    vector_push(children4, right4)
    __mf_poke_i64(ast_div + AST_CHILDREN, children4)
    
    var result4 = compile_and_execute(ast_div, "test4.morph")
    sistem 1, 1, "Result: ", 8
    print_number_simple(result4)
    sistem 1, 1, " (expected: 4)\n", 15
    
    ; Summary
    sistem 1, 1, "\nðŸŽ‰ Self-Hosting Compiler + Executor Summary:\n", 45
    sistem 1, 1, "âœ… AST â†’ Intent Tree conversion\n", 32
    sistem 1, 1, "âœ… Intent Tree â†’ RPN compilation\n", 33
    sistem 1, 1, "âœ… RPN â†’ Stripe-protected .morph files\n", 39
    sistem 1, 1, "âœ… .morph file execution with Stack VM\n", 39
    sistem 1, 1, "âœ… Complete validation loop working\n", 36
    
    sistem 1, 1, "\nðŸ”’ Security Features:\n", 22
    sistem 1, 1, "âœ… Stripe protection for .morph files\n", 38
    sistem 1, 1, "âœ… Assembly code obfuscation\n", 29
    sistem 1, 1, "âœ… Integrity checking\n", 22
    
    sistem 1, 1, "\nSelf-hosting capability achieved! ðŸš€\n", 38
    kembali 0
}

; Helper function: compile AST and execute
fungsi compile_and_execute(ast: ptr, filename: ptr) -> i64
    ; Compile AST to RPN
    var rpn_ctx = compile_ast_to_rpn(ast)
    jika rpn_ctx == 0
        kembali -1
    tutup_jika
    
    ; Write to .morph file
    var write_result = rpn_write_morph_file(rpn_ctx, filename)
    jika write_result == 0
        kembali -2
    tutup_jika
    
    ; Execute .morph file
    var result = execute_morph_file(filename)
    kembali result
tutup_fungsi
